#!/usr/bin/env bash
# -*- bash -*-
#
#
action="$1"
shift

set -u -e -o pipefail

BIN=/apps/bash_setup/bin
function git_is_clean {
    if ! git_repo_is_clean
    then
      echo -e "\n!!! GIT repo not clean enough.\n" 1>&2
      exit 1
    fi
}


case "$action" in

  "help")
    echo " ====================================================="
    echo ""
    echo " $ bash_setup bump current"
    echo " $ bash_setup bump major"
    echo " $ bash_setup bump minor"
    echo " $ bash_setup bump patch"
    echo " $ bash_setup bump_and_commit  major|minor|patch"
    echo ""
    echo " $ bash_setup install_rethinkdb"
    echo " ====================================================="
    echo ""
    exit 0
    ;;

  "install_rethinkdb")
    source /etc/lsb-release && echo "deb http://download.rethinkdb.com/apt $DISTRIB_CODENAME main" | sudo tee /etc/apt/sources.list.d/rethinkdb.list
    wget -qO- http://download.rethinkdb.com/apt/pubkey.gpg | sudo apt-key add -
    sudo apt-get update
    sudo apt-get install rethinkdb
    ;;

  "bump")
    PATH="/progs/ruby/current/bin:$PATH"
    if [[ -z "$(which bump)" ]]; then
      echo "!!! install rubygem: gem install bump"
      exit 1
    fi
    if [[ "$1" != "current" ]]; then
      git_is_clean
      echo -e "=== Bumping from: $(bump current)\n"
    fi
    bump $1 --no-commit --no-bundle
    ;;

  "bump_and_commit")
    bash_setup bump "$1"
    VER=$(cat VERSION)

    git_update
    git commit -m   "Bump: $VER"
    git tag         "v$VER"
    git push origin "v$(cat VERSION)"
    git push
    ;;

  *)
    echo "Unknown option: $action" 1>&2
    exit 1
    ;;

esac


